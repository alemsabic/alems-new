"use strict";
var __makeTemplateObject = (this && this.__makeTemplateObject) || function (cooked, raw) {
    if (Object.defineProperty) { Object.defineProperty(cooked, "raw", { value: raw }); } else { cooked.raw = raw; }
    return cooked;
};
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ArticleCard$ = exports.ArticleCard = void 0;
var html_1 = require("@connectv/html");
var transport_1 = require("@connectv/sdh/transport");
var rxjs_1 = require("rxjs");
var style_1 = require("./style");
function extractTitle(title) {
    var _a;
    if (title) {
        if ((_a = window.source) === null || _a === void 0 ? void 0 : _a.title) {
            var prefix = window.source.title.base + window.source.title.connector;
            if (title.startsWith(prefix))
                return title.substr(prefix.length);
            else
                return title;
        }
    }
    else
        return title;
}
function ArticleCard(options, renderer) {
    var classes = this.theme.classes(style_1.ArticleCardStyle);
    var src = new rxjs_1.BehaviorSubject(options.src);
    var img = new rxjs_1.BehaviorSubject('https://coding.blog/banner.svg');
    var title = new rxjs_1.BehaviorSubject('Some Article');
    var desc = new rxjs_1.BehaviorSubject('Some description for this article');
    this.track({
        bind: function () {
            var _a;
            var url = options.src;
            if (options.src.startsWith('/')) {
                url = "" + (((_a = window.source) === null || _a === void 0 ? void 0 : _a.namespace) || '') + options.src;
            }
            src.next(url);
            fetch(url)
                .then(function (response) { return response.text(); })
                .then(function (html) {
                var marker = renderer.create("div", null);
                marker.innerHTML = html;
                var candidate;
                if (candidate = marker.querySelector('meta[property="og:title"], meta[name="twitter:title"]'))
                    title.next(extractTitle(candidate.getAttribute('content')) || title.value);
                else if (candidate = marker.querySelector('head > title'))
                    title.next(extractTitle(candidate.textContent) || title.value);
                if (candidate = marker.querySelector('meta[property="og:description"],' +
                    'meta[name="twitter:description"],' +
                    'meta[name="description"]')) {
                    desc.next(candidate.getAttribute('content') || '');
                }
                else if (candidate = marker.querySelector('#-codedoc-container > p')) {
                    desc.next(candidate.textContent || '');
                }
                else {
                    desc.next('');
                }
                if (candidate = marker.querySelector('meta[property="og:image"], meta[name="twitter:image"]'))
                    img.next(candidate.getAttribute('content') || img.value);
                else if (candidate = marker.querySelector('img[data-hero]')) {
                    img.next(candidate.getAttribute('src') || img.value);
                }
            });
        }
    });
    return renderer.create("a", __assign({}, (options.style === 'box' ? { 'data-article-card-grid': '' } : {}), { href: src, class: classes.card + " " + (options.style === 'box' ? classes.cardcol : '') }),
        renderer.create("div", { style: html_1.rl(templateObject_1 || (templateObject_1 = __makeTemplateObject(["background-image: url('", "')"], ["background-image: url('", "')"])), img), class: classes.img }),
        renderer.create("div", { class: classes.text },
            renderer.create("h1", null, title),
            renderer.create("p", null, desc)));
}
exports.ArticleCard = ArticleCard;
exports.ArticleCard$ = transport_1.transport(ArticleCard);
var templateObject_1;
//# sourceMappingURL=index.js.map